name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - "terraform/**"
      - ".github/workflows/plan.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_DIR: terraform
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ${{ env.TF_DIR }}
        run: terraform validate

      - name: Terraform Plan (binary)
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -input=false -no-color -out=tfplan.bin

      - name: Export plan as text
        working-directory: ${{ env.TF_DIR }}
        run: terraform show -no-color tfplan.bin > tfplan.txt

      - name: Upload plan txt artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ${{ env.TF_DIR }}/tfplan.txt
          retention-days: 7

      - name: Add plan preview to Job Summary
        if: always()
        working-directory: ${{ env.TF_DIR }}
        run: |
          echo "## Terraform plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifact: **terraform-plan** (tfplan.txt)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Preview (first 200 lines)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 200 tfplan.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR (short)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = [
              "Terraform plan is ready.",
              "",
              "Check the workflow run summary for a preview and download the artifact **terraform-plan** to open `tfplan.txt`."
            ].join("\n");
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });