name: Terraform Plan

on:
  pull_request:
    branches: [main]
    paths:
      - "terraform/**"
      - ".github/workflows/plan.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  TF_DIR: terraform
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  plan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init -input=false

      - name: Terraform Plan
        working-directory: ${{ env.TF_DIR }}
        run: terraform plan -input=false -no-color -out=tfplan.bin

      - name: Export plan to text
        working-directory: ${{ env.TF_DIR }}
        run: terraform show -no-color tfplan.bin > tfplan.txt

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ${{ env.TF_DIR }}/tfplan.txt
          retention-days: 7

      - name: Job Summary
        if: always()
        run: |
          echo "## Terraform plan" >> "$GITHUB_STEP_SUMMARY"
          if [ -f "${{ env.TF_DIR }}/tfplan.txt" ]; then
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Artifact: **terraform-plan** (tfplan.txt)" >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "### Preview (first 120 lines)" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            head -n 120 "${{ env.TF_DIR }}/tfplan.txt" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Plan output not generated. Check the logs above (init/plan likely failed)." >> "$GITHUB_STEP_SUMMARY"
          fi